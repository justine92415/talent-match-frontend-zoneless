<!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
@if (isLoading()) {
  <div class="flex justify-center items-center py-12">
    <div
      class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"
    ></div>
    <span class="ml-3 text-grey-66">è¼‰å…¥ä¸­...</span>
  </div>
}

<!-- éŒ¯èª¤ç‹€æ…‹ -->
@if (error()) {
  <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
    <div class="flex">
      <mat-icon class="text-red-500 mr-3">error</mat-icon>
      <div>
        <h3 class="text-red-800 font-medium">è¼‰å…¥å¤±æ•—</h3>
        <p class="text-red-700 mt-1">{{ error() }}</p>
        <tmf-button
          type="button"
          variant="secondary"
          class="mt-3"
          (click)="loadCourseDetail()"
        >
          é‡æ–°è¼‰å…¥
        </tmf-button>
      </div>
    </div>
  </div>
}

<!-- èª²ç¨‹è©³æƒ… -->
@if (!isLoading() && !error() && courseDetail()) {
  <div class="relative">
    <div
      [style]="{
        backgroundImage: 'url(' + course().main_image + ')',
      }"
      class="relative h-134.5 w-full bg-cover bg-center bg-no-repeat xl:h-[575px]"
    >
      <div
        class="h-full w-full bg-[#10101099] px-3 pb-12 pt-6 backdrop-blur-sm xl:flex xl:items-center xl:p-0"
      >
        <div
          class="flex flex-col gap-6 xl:container xl:mx-auto xl:w-320 xl:flex-row xl:justify-between"
        >
          <!-- èª²ç¨‹ç¸®åœ– -->
          <div
            class="box-border h-49 w-87.5 overflow-hidden rounded-xl border border-grey-9f shadow-lg xl:h-103.75 xl:w-184.5"
          >
            <img
              class="h-full w-full object-cover"
              [src]="course().main_image || 'assets/images/guitar-course.png'"
              [alt]="course().name || 'èª²ç¨‹åœ–ç‰‡'"
            />
          </div>
          <div class="flex flex-col gap-3 xl:flex-grow xl:py-3">
            <!-- æ¨™ç±¤ -->
            <div class="flex items-center gap-3 xl:pb-6">
              <div
                class="inline-block rounded bg-black p-1 text-xs font-bold text-yellow xl:p-2 xl:text-sm"
              >
                {{ course().main_category?.name }}
              </div>
              <div
                class="inline-block rounded bg-black p-1 text-xs font-bold text-yellow xl:p-2 xl:text-sm"
              >
                {{ course().sub_category?.name }}
              </div>
            </div>
            <!-- è€å¸«é ­è²¼ã€åå­— -->
            <div class="flex items-center gap-2">
              <img
                class="h-8 w-8 rounded-full border border-grey-e9"
                [src]="
                  teacher()?.user?.avatar_image ||
                  'assets/images/teacher-avatar-1.jpg'
                "
                [alt]="teacher()?.user?.name + ' é ­åƒ'"
              />
              <p
                class="cursor-pointer text-base font-medium text-white"
                (click)="navigateToTeacherDetail()"
              >
                {{ teacher()?.user?.name }}
              </p>
            </div>
            <!-- èª²ç¨‹åç¨± -->
            <h1 class="text-lg font-bold text-white xl:text-3xl">
              {{ course().name }}
            </h1>
            <!-- åœ°å€ã€è©•åˆ† -->
            <div class="flex items-center gap-3">
              <div
                class="flex items-center justify-center gap-1 text-white xl:border-r xl:border-grey-9f xl:pr-[0.6875rem]"
              >
                <mat-icon class="!text-xl !leading-5 !w-5 !h-5"
                  >pin_drop</mat-icon
                >
                <p>{{ teacher()?.city }} {{ teacher()?.district }}</p>
              </div>
              <div
                class="font-inter flex h-full items-center justify-center gap-1 text-white xl:border-r xl:border-grey-9f xl:pr-[0.6875rem]"
              >
                <tmf-star-rating
                  [rating]="course().rate || 0"
                  starSize="medium"
                ></tmf-star-rating>
                <p class="text-sm font-medium">{{ course().rate || 0 }}</p>
                <p class="text-sm font-medium">
                  ( {{ course().review_count || 0 }} )
                </p>
              </div>
              <div
                class="font-inter hidden items-center gap-1 text-white xl:flex"
              >
                <mat-icon class="!text-xl !leading-5 !w-5 !h-5">face</mat-icon>
                <p>{{ course().student_count || 0 }}</p>
              </div>
            </div>
            <!-- å­¸ç¿’äººæ•¸ -->
            <div
              class="flex items-center justify-start gap-1 text-white xl:hidden"
            >
              <mat-icon class="!text-xl !leading-5 !w-5 !h-5">face</mat-icon>
              <p>å­¸ç¿’äººæ•¸è³‡è¨Š</p>
            </div>
            <!-- æŒ‰éˆ• -->
            <div
              class="flex items-center gap-3 pt-6 xl:flex-grow xl:items-end xl:pt-0"
            >
              <tmf-button
                class="h-10"
                variant="tertiary"
                iconPosition="left"
                iconName="heart_plus"
                >æ”¶è—èª²ç¨‹</tmf-button
              >
              <tmf-button
                class="h-10"
                variant="ghost"
                iconPosition="left"
                iconName="share"
                >åˆ†äº«èª²ç¨‹</tmf-button
              >
            </div>
          </div>
        </div>
      </div>
      <div
        class="h-0.5 w-full bg-gradient-to-r from-[#F7F7F7] via-[#8D0099] to-[#F7F7F7]"
      ></div>
    </div>
    <!-- nav -->
    <nav
      class="sticky top-0 z-50 border-b border-grey-d4 bg-white px-3 pb-4 pt-3"
    >
      <ul
        class="flex items-center justify-between gap-7.5 text-base text-grey-66 xl:container xl:mx-auto xl:w-320 xl:justify-start xl:gap-8"
      >
        <li>
          <a
            class="py-3"
            [ngClass]="{ active: activeSection() === 'sectionA' }"
            [routerLink]="['/course-detail/', 'course_id']"
            fragment="sectionA"
            >èª²ç¨‹ä»‹ç´¹</a
          >
        </li>
        <li>
          <a
            class="py-3"
            [ngClass]="{ active: activeSection() === 'sectionB' }"
            [routerLink]="['/course-detail/', 'course_id']"
            fragment="sectionB"
            >æˆèª²æ™‚é–“</a
          >
        </li>
        <li>
          <a
            class="py-3"
            [ngClass]="{ active: activeSection() === 'sectionC' }"
            [routerLink]="['/course-detail/', 'course_id']"
            fragment="sectionC"
            >å­¸ç”Ÿè©•è«–</a
          >
        </li>
        <li>
          <a
            class="py-3"
            [ngClass]="{ active: activeSection() === 'sectionD' }"
            [routerLink]="['/course-detail/', 'course_id']"
            fragment="sectionD"
            >æ•™å¸«å±¥æ­·</a
          >
        </li>
      </ul>
    </nav>
    <div
      class="flex flex-col gap-6 pb-12 pt-6 xl:container xl:mx-auto xl:w-320 xl:flex-row xl:pb-20 xl:pt-10"
    >
      <div class="mb-6 flex flex-col gap-12 xl:min-w-[845px] xl:pr-6">
        <!-- èª²ç¨‹ä»‹ç´¹ -->
        <section id="sectionA" #section>
          <tmf-course-detail-section-title
            >èª²ç¨‹ä»‹ç´¹</tmf-course-detail-section-title
          >
          <p class="mb-4 text-sm text-grey-33 xl:text-base whitespace-pre-wrap">
            {{ course().content || "èª²ç¨‹ä»‹ç´¹è³‡è¨Šæš«ç„¡æä¾›" }}
          </p>
          <!-- å½±ç‰‡å€å¡Š -->
          @if (videoCards().length > 0) {
            <div
              class="custom-scrollbar flex w-full items-center gap-6 overflow-x-auto pb-8"
            >
              @for (videoCard of videoCards(); track videoCard.id; let i = $index) {
                <div class="cursor-pointer" (click)="openVideoViewer(i)">
                  <tmf-video-card [video]="videoCard">
                  </tmf-video-card>
                </div>
              }
            </div>
          }
        </section>

        <!-- æˆèª²æ™‚é–“ -->
        <section id="sectionB" #section>
          <tmf-course-detail-section-title
            >æˆèª²æ™‚é–“</tmf-course-detail-section-title
          >

          <div class="custom-scrollbar w-full overflow-x-auto pb-8">
            <!-- æ—¥æ›† -->
            <tmf-weekly-calendar [scheduleData]="schedule()"></tmf-weekly-calendar>
          </div>
        </section>

        <!-- å­¸ç”Ÿè©•è«– -->
        <section id="sectionC" #section>
          <div class="h-9 mb-4 flex justify-between">
            <tmf-course-detail-section-title
              >å­¸ç”Ÿè©•è«–</tmf-course-detail-section-title
            >
            <tmf-button variant="secondary" [iconName]="'keyboard_arrow_right'">
              <p class="text-sm font-normal">é¡¯ç¤ºæ‰€æœ‰è©•åƒ¹</p>
            </tmf-button>
          </div>
          <!-- è©•è«–å€ -->
          <div class="flex flex-col gap-4">
            @if (hasReviews()) {
              @for (review of reviews(); track review.id) {
                <tmf-review-card
                  class="w-full"
                  type="bordered"
                  [review]="{
                    id: review.id.toString(),
                    name: review.user.nick_name,
                    date: (review.created_at | date: 'yyyy-MM-dd') || '',
                    title: '',
                    content: review.comment,
                    rating: review.rate,
                    avatar: review.user.avatar_image || undefined
                  }"
                ></tmf-review-card>
              }
            } @else {
              <div class="text-center p-8 text-grey-66">
                <div class="mb-2">ğŸ’¬</div>
                <div>å°šç„¡è©•è«–</div>
              </div>
            }
          </div>
        </section>

        <!-- æ•™å¸«å±¥æ­· -->
        <section id="sectionD" #section>
          <tmf-course-detail-section-title
            >æ•™å¸«å±¥æ­·</tmf-course-detail-section-title
          >
          <div
            class="flex flex-col gap-3 rounded-xl border border-orange-85 bg-white p-3 xl:gap-6 xl:p-6"
          >
            <div class="flex items-center gap-2 xl:gap-6">
              <img
                class="h-16 w-16 rounded-full border border-grey-e9 xl:h-20 xl:w-20"
                [src]="'course.teacher.avatar'"
                alt=""
              />
              <div>
                <p class="text-lg font-medium text-grey-33 xl:mb-1 xl:text-2xl">
                  Eric Clapton
                </p>
                <p class="text-sm font-medium text-grey-9f">
                  ç´¯ç©å®Œæˆ 120 å ‚èª²ç¨‹
                </p>
              </div>
            </div>
            <!-- è‡ªä»‹ -->
            <p
              class="line-clamp-3 text-base text-grey-33"
              [innerHTML]="teacher()?.introduction || 'æ•™å¸«è‡ªä»‹è³‡è¨Šæš«ç„¡æä¾›'"
            ></p>
            <!-- å·¥ä½œç¶“é©— -->
            <div>
              <p class="mb-1 text-xs text-grey-9f xl:text-sm">å·¥ä½œç¶“é©—</p>
              <ul
                class="list-disc pl-6 text-sm font-medium text-grey-33 xl:text-sm"
              >
                @for (
                  work_experience of work_experiences();
                  track work_experience.id
                ) {
                  <li>
                    {{ work_experience.start_year }}-{{
                      work_experience.end_year || "è‡³ä»Š"
                    }}ï½œ{{ work_experience.company_name }}ï½œ{{
                      work_experience.job_title
                    }}
                  </li>
                }
              </ul>
            </div>
            <!-- æ•™è‚²èƒŒæ™¯ -->
            <div>
              <p class="mb-1 text-xs text-grey-9f xl:text-sm">æ•™è‚²èƒŒæ™¯</p>
              <ul
                class="list-disc pl-6 text-sm font-medium text-grey-33 xl:text-sm"
              >
                @for (education of educations(); track education.id) {
                  <li>
                    {{ education.start_year }}-{{
                      education.end_year || "è‡³ä»Š"
                    }}ï½œ{{ education.school_name }}ï½œ{{ education.degree }}
                  </li>
                }
              </ul>
            </div>
            <!-- è­‰ç…§è­‰æ›¸ -->
            <div>
              <p class="mb-1 text-xs text-grey-9f xl:text-sm">è­‰ç…§è­‰æ›¸</p>
              <ul
                class="list-disc pl-6 text-sm font-medium text-grey-33 xl:text-sm"
              >
                @for (certificate of certificates(); track certificate.id) {
                  <li>{{ certificate.license_name }}</li>
                }
              </ul>
            </div>
            <div class="flex justify-end">
              <button (click)="openTeacherDetailPage()">
                <div class="flex items-center gap-1 text-primary">
                  <p class="text-sm xl:text-base">äº†è§£æ›´å¤šæ•™å¸«å±¥æ­·</p>
                  <mat-icon class="!text-xl !leading-5 !w-5 !h-5"
                    >chevron_right</mat-icon
                  >
                </div>
              </button>
            </div>
          </div>
        </section>
      </div>

      <!-- èª²ç¨‹æ–¹æ¡ˆ -->
      <div class="w-full">
        <div
          class="flex flex-col gap-3 rounded-xl border border-grey-d4 bg-white p-3 xl:gap-6 xl:border-0 xl:p-6 xl:shadow-lg"
        >
          <div class="text-xl font-bold text-grey-33">èª²ç¨‹æ–¹æ¡ˆ</div>
          <!-- æ–¹æ¡ˆé¸æ“‡ -->
          <div class="flex flex-col gap-3" [formGroup]="formGroup">
            @if (
              courseDetail()?.price_options &&
              (courseDetail()?.price_options)!.length > 0
            ) {
              @for (option of courseDetail()?.price_options; track option.id) {
                <tmf-input-plan
                  formControlName="purchase_item_id"
                  [title]="option.quantity + ' å ‚èª²ç¨‹'"
                  [price]="option.price || 0"
                  [value]="option.id.toString()"
                  name="purchase_item_id"
                >
                </tmf-input-plan>
              }
            } @else {
              <p class="text-grey-66 text-sm">æš«ç„¡èª²ç¨‹æ–¹æ¡ˆ</p>
            }
          </div>
          <!-- ç«‹å³è³¼è²·ã€è³¼ç‰©è»Š -->
          <div
            class="flex items-center justify-between gap-3 border-b border-dashed border-grey-d4 pb-6 xl:gap-4"
          >
            <tmf-button
              class="w-full h-13"
              variant="primary"
              [disabled]="!this.formGroup.controls.purchase_item_id.value || isAddingToCart()"
              (click)="buyNow()"
              >{{ isAddingToCart() ? 'è™•ç†ä¸­...' : 'ç«‹å³è³¼è²·' }}</tmf-button
            >
            <button
              class="h-13 w-13 box-border group rounded-lg border p-3 transition-all duration-300 ease-in-out hover:w-auto hover:px-4"
              [ngClass]="{
                'border-grey-9f bg-grey-9f text-white cursor-not-allowed':
                  !this.formGroup.controls.purchase_item_id.value || isAddingToCart(),
                'border-primary bg-white text-primary cursor-pointer':
                  this.formGroup.controls.purchase_item_id.value && !isAddingToCart(),
              }"
              [disabled]="!this.formGroup.controls.purchase_item_id.value || isAddingToCart()"
              (click)="addToCart()"
            >
              <div
                class="flex items-center gap-0 group-hover:gap-2 transition-all duration-300 ease-in-out"
              >
                <span
                  class="material-symbols-outlined flex items-center text-xl leading-5 xl:!text-[28px] xl:!leading-7"
                  >shopping_cart</span
                >
                <span
                  class="whitespace-nowrap text-base-bold xl:text-lg-bold xl:leading-7 max-w-0 overflow-hidden transition-all duration-300 ease-in-out group-hover:max-w-30 opacity-0 group-hover:opacity-100"
                  >åŠ å…¥è³¼ç‰©è»Š</span
                >
              </div>
            </button>
          </div>
          <!-- å•å· -->
          <div>
            <p class="mb-3 text-sm text-grey-66 xl:text-base">
              æˆ–è¨±ä½ æƒ³åœ¨ä¸Šèª²å‰å…ˆè«®è©¢æ•™å¸«
            </p>

            <tmf-button
              variant="secondary"
              class="h-13"
              customClasses="bg-white text-purple border border-purple hover:bg-purple hover:text-white cursor-pointer"
            >
              å¡«å¯«èª²å‰è«®è©¢å•å·
            </tmf-button>
          </div>
        </div>
      </div>
    </div>
    <!-- åº•éƒ¨å›ºå®šæ¬„ä½ -->
    <div
      class="custom-shadow sticky bottom-0 h-[92px] w-full rounded-xl bg-white px-4 py-3 xl:hidden"
    >
      <div class="flex gap-1 text-sm text-grey-33">
        <p>ç›®å‰æ–¹æ¡ˆï¼š</p>
        <p>å–®å ‚èª²ç¨‹</p>
      </div>
      <div class="flex items-center justify-between">
        <div class="flex gap-1 text-2xl font-medium text-grey-33">
          <p>NT$</p>
          <p>1,200</p>
        </div>
        <button
          class="rounded-lg bg-primary px-4 py-3 text-base font-bold text-white"
        >
          æŸ¥çœ‹æ–¹æ¡ˆ
        </button>
      </div>
    </div>
    <!-- æ¨è–¦èª²ç¨‹ -->
    <div
      class="hidden bg-grey-f7 pb-20 pt-10 xl:flex xl:items-center xl:justify-center"
    >
      <div class="xl:container xl:w-320">
        <tmf-course-detail-section-title
          >å…¶ä»–æ¨è–¦èª²ç¨‹</tmf-course-detail-section-title
        >
        <div class="flex gap-6">
          <!-- @if (recommendCourse$ | async; as recommendCourses) { @for (
        recommendCourse of recommendCourses; track recommendCourse.course_id ) {
        <tmf-card [hoverEffect]="false" [data]="recommendCourse!"></tmf-card>
        } } -->
        </div>
      </div>
    </div>
  </div>
}

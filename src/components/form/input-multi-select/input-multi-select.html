<div class="relative">
  <!-- Trigger Button -->
  <button
    #trigger
    type="button"
    class="flex font-normal gap-1 items-center justify-between w-full px-3 py-2 bg-white border border-grey-d4 rounded-xl text-grey-9f transition-all duration-200 focus:outline-none focus:border-primary"
    [class.border-primary]="isOpen()"
    [class.border-red-500]="ctrlDir.touched && ctrlDir.invalid"
    [class.text-grey-33]="selectedValues().length > 0"
    (click)="toggleDropdown()"
    [disabled]="isDisabled()"
  >
    <span class="text-base text-left flex-1">
      {{ displayText() }}
    </span>
    <mat-icon [class]="{ '!text-primary': isOpen() }">
      keyboard_arrow_down
    </mat-icon>
  </button>

  <!-- CDK Overlay Template -->
  <ng-template #dropdownTemplate>
    <div
      class="bg-white rounded-xl shadow-lg py-3 z-50 w-full"
      style="background-color: white !important"
    >
      <!-- Header with clear all button -->
      @if (selectedValues().length > 0) {
        <div class="flex items-center justify-between px-6 py-2 border-b border-grey-f7">
          <span class="text-sm text-grey-66">已選擇 {{ selectedValues().length }} 項</span>
          <button
            type="button"
            class="text-sm text-primary hover:underline"
            (click)="clearAll()"
          >
            清除全部
          </button>
        </div>
      }

      <!-- Options list -->
      <ul class="max-h-60 overflow-y-auto">
        @for (option of options(); track option.value) {
        <li>
          <button
            type="button"
            class="w-full flex items-center gap-3 px-6 py-3 text-base text-grey-33 hover:bg-grey-f7 hover:text-orange-55 transition-colors duration-200 cursor-pointer text-left"
            [class.bg-grey-f7]="isOptionSelected(option)"
            [class.text-primary]="isOptionSelected(option)"
            (click)="toggleOption(option)"
          >
            <!-- Hidden Checkbox -->
            <input
              type="checkbox"
              class="peer hidden"
              [checked]="isOptionSelected(option)"
              readonly
            />
            <span class="flex-1">{{ option.label }}</span>
            <span
              class="material-symbols-outlined !text-[20px] !leading-[20px] text-primary transition-opacity duration-200 opacity-0 peer-checked:opacity-100"
            >
              check
            </span>
          </button>
        </li>
        }
      </ul>
    </div>
  </ng-template>
</div>
<div>
  @if(ctrlDir.touched && ctrlDir.invalid) {
  <div class="mt-1 text-sm text-red-500">
    {{ ctrlDir.getError('error') }}
  </div>
  }
</div>
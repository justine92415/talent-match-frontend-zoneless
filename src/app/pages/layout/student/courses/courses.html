<div class="bg-white">
  <div class="container mx-auto px-4 py-8">
    <!-- 頁面標題 -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h1 class="text-3xl font-bold text-grey-33 mb-2">我的購課記錄</h1>
          <p class="text-grey-66">查看已購買的課程，並進行預約管理</p>
        </div>

      </div>
    </div>

    <!-- 載入狀態 -->
    @if (purchasesResource.isLoading()) {
      <div class="flex justify-center items-center py-12">
        <div class="text-grey-66 text-lg">載入中...</div>
      </div>
    }

    <!-- 錯誤狀態 -->
    @if (purchasesResource.error()) {
      <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
        <div class="text-red-600 text-lg mb-2">載入失敗</div>
        <div class="text-grey-66 mb-4">無法載入購課記錄，請稍後再試</div>
        <tmf-button
          variant="primary"
          (click)="purchasesResource.reload()">
          重新載入
        </tmf-button>
      </div>
    }

    <!-- 課程列表 -->
    @if (purchasesResource.value()?.data?.purchases; as purchases) {
      <div class="space-y-6">
        @for (purchase of purchases; track purchase.id) {
        <div class="bg-white rounded-lg border border-grey-d4 overflow-hidden hover:shadow-lg transition-shadow duration-200">
          <!-- 課程主要資訊 -->
          <div class="flex gap-4 p-6">
            <!-- 課程圖片 -->
            <div class="flex-shrink-0">
              <img
                [src]="purchase.course?.main_image || 'https://picsum.photos/120/90?random=' + purchase.course?.id"
                [alt]="purchase.course?.name"
                class="w-30 h-22.5 rounded-lg object-cover"
              />
            </div>

            <!-- 課程詳細資訊 -->
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h3 class="text-xl font-bold text-grey-33 mb-2">{{ purchase.course?.name }}</h3>
                  <p class="text-grey-66 text-sm">
                    指導老師：{{ purchase.course?.teacher?.user?.nick_name || purchase.course?.teacher?.user?.name }}
                  </p>
                </div>
              </div>

              <!-- 堂數資訊 -->
              <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="text-center bg-grey-f4 rounded-lg p-3">
                  <div class="text-2xl font-bold text-primary">{{ purchase.quantity_total }}</div>
                  <div class="text-sm text-grey-66">總堂數</div>
                </div>
                <div class="text-center bg-grey-f4 rounded-lg p-3">
                  <div class="text-2xl font-bold text-orange-55">{{ purchase.quantity_used }}</div>
                  <div class="text-sm text-grey-66">已使用</div>
                </div>
                <div class="text-center bg-grey-f4 rounded-lg p-3">
                  <div class="text-2xl font-bold text-green-55">{{ purchase.quantity_remaining }}</div>
                  <div class="text-sm text-grey-66">剩餘堂數</div>
                </div>
              </div>


              <!-- 操作按鈕 -->
              <div class="flex gap-3">
                <tmf-button
                  class="h-10 flex-1"
                  variant="primary"
                  [disabled]="(purchase.quantity_remaining ?? 0) === 0"
                  (click)="onBookCourse(purchase.course?.id!)">
                  @if ((purchase.quantity_remaining ?? 0) > 0) {
                    預約課程
                  } @else {
                    已用完
                  }
                </tmf-button>

                <tmf-button
                  class="h-10 flex-1"
                  variant="secondary"
                  (click)="onViewReservations(purchase.course?.id!)">
                  @if (isReservationExpanded(purchase.course?.id!)) {
                    收起預約
                  } @else {
                    查看預約
                  }
                </tmf-button>
              </div>
            </div>
          </div>

          <!-- 展開的預約記錄區塊 -->
          @if (isReservationExpanded(purchase.course?.id!)) {
            <div class="border-t border-grey-d4 bg-grey-f9 p-6">
              <h4 class="text-lg font-bold text-grey-33 mb-4">預約記錄</h4>
              <tmf-course-reservations
                [courseId]="purchase.course?.id!"
                [reservationUpdated$]="reservationUpdated$"
                (reservationCancelled)="onReservationCancelled($event)" />
            </div>
          }
        </div>
      }

        <!-- 空狀態 -->
        @if (purchases.length === 0) {
          <div class="flex flex-col  items-center text-center py-12">
            <img src="/assets/images/search_none.png" alt="暫無預約記錄" class="w-48 h-48 mx-auto opacity-60">
            <div class="text-grey-66 text-lg mb-4">尚未購買任何課程</div>
            
            <tmf-button
              class="h-12 w-40"
              variant="primary">
              探索課程
            </tmf-button>
          </div>
        }
      </div>
    }
  </div>
</div>

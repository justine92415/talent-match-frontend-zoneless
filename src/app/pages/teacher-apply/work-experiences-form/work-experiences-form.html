<form
  [formGroup]="formGroup()"
  class="space-y-6"
>
  <div formArrayName="experiences">
    @for (experience of experiencesArray.controls; track experience) {
      <div
        [formGroupName]="$index"
        class="border border-grey-d4 rounded-xl p-6 space-y-4 relative"
      >
        <!-- 刪除按鈕 -->
        @if (experiencesArray.length > 1) {
          <button
            type="button"
            (click)="removeExperience($index)"
            class="absolute top-4 right-4 text-red-500 hover:text-red-700 transition-colors"
          >
            <mat-icon> {{TmfIcon.Delete}} </mat-icon>
          </button>
        }

        <h3 class="text-lg font-medium text-grey-33">工作經驗 {{ $index + 1 }}</h3>

        <!-- 公司名稱 -->
        <div class="space-y-2">
          <label class="block text-base font-medium text-grey-33">公司名稱</label>
          <tmf-input-text
            placeholder="請輸入公司名稱"
            formControlName="company_name"
          ></tmf-input-text>
        </div>

        <!-- 工作地點 -->
        <div class="space-y-4">
          <label class="block text-base font-medium text-grey-33">工作地點</label>

          <div class="flex flex-col md:flex-row gap-4">
            <!-- 縣市 -->
            <div class="space-y-2 flex-1">
              <label class="block text-sm text-grey-66">縣市</label>
              <tmf-input-select
                [placeholder]="'請選擇縣市'"
                [options]="cityOptions"
                formControlName="city"
              ></tmf-input-select>
            </div>

            <!-- 地區 -->
            <div class="space-y-2 flex-1">
              <label class="block text-sm text-grey-66">地區</label>
              <tmf-input-select
                [placeholder]="'請選擇地區'"
                [options]="getDistrictOptions($index)"
                formControlName="district"
              ></tmf-input-select>
            </div>
          </div>
        </div>

        <!-- 工作類別與職稱 -->
        <div class="flex flex-col md:flex-row gap-4">
          <div class="space-y-2">
            <label class="block text-base font-medium text-grey-33">工作類別</label>
            <tmf-input-select
              [placeholder]="'請選擇工作類別'"
              [options]="jobCategoryOptions"
              formControlName="job_category"
            ></tmf-input-select>
          </div>

          <div class="space-y-2">
            <label class="block text-base font-medium text-grey-33">職稱</label>
            <tmf-input-text
              placeholder="請輸入職稱"
              formControlName="job_title"
            ></tmf-input-text>
          </div>
        </div>

        <!-- 目前在職 checkbox -->
        <tmf-input-checkbox
          label="目前在職"
          formControlName="is_working"
        ></tmf-input-checkbox>

        <!-- 工作期間 -->
        <div class="space-y-4">
          <label class="block text-base font-medium text-grey-33">工作期間</label>
          
          <!-- 開始時間 -->
          <div class="space-y-2">
            <label class="block text-sm text-grey-66">開始時間</label>
            <div class="flex gap-4">
              <tmf-input-select
                [placeholder]="'年'"
                [options]="yearOptions"
                formControlName="start_year"
                class="flex-1"
              ></tmf-input-select>
              <tmf-input-select
                [placeholder]="'月'"
                [options]="monthOptions"
                formControlName="start_month"
                class="flex-1"
              ></tmf-input-select>
            </div>
            @if (
              (experience.get("start_year")?.invalid && experience.get("start_year")?.touched) ||
              (experience.get("start_month")?.invalid && experience.get("start_month")?.touched)
            ) {
              <div class="text-red-500 text-sm">請選擇開始時間</div>
            }
          </div>

          <!-- 結束時間 -->
          @if (!experience.get("is_working")?.value) {
            <div class="space-y-2">
              <label class="block text-sm text-grey-66">結束時間</label>
              <div class="flex gap-4">
                <tmf-input-select
                  [placeholder]="'年'"
                  [options]="yearOptions"
                  formControlName="end_year"
                  class="flex-1"
                ></tmf-input-select>
                <tmf-input-select
                  [placeholder]="'月'"
                  [options]="monthOptions"
                  formControlName="end_month"
                  class="flex-1"
                ></tmf-input-select>
              </div>
              @if (
                (experience.get("end_year")?.invalid && experience.get("end_year")?.touched) ||
                (experience.get("end_month")?.invalid && experience.get("end_month")?.touched)
              ) {
                <div class="text-red-500 text-sm">請選擇結束時間</div>
              }
            </div>
          }

          <!-- 日期範圍驗證錯誤 -->
          @if (experience.hasError('dateRangeInvalid') && experience.touched) {
            <div class="text-red-500 text-sm">結束日期不得早於開始日期</div>
          }
        </div>
      </div>
    }
  </div>

  <!-- 新增工作經驗按鈕 -->
  <div class="flex justify-center">
    <tmf-button
      type="button"
      variant="secondary"
      iconPosition="left"
      iconName="add"
      (click)="addExperience()"
      class="h-10"
    >
      新增工作經驗
    </tmf-button>
  </div>
</form>

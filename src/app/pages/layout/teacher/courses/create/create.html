<div>
  <!-- 頁面標題 -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-grey-33 mb-2">新增課程</h1>
    <p class="text-grey-66">建立一個新的課程，設定基本資訊和課程方案</p>
  </div>

  <!-- 課程建立表單 -->
  <form [formGroup]="courseForm" class="space-y-8">

    <!-- 課程圖片上傳區域 -->
    <div class="bg-white border border-grey-d4 rounded-xl shadow-sm p-6">
      <h2 class="text-xl font-semibold text-grey-33 mb-4">課程圖片</h2>

      <!-- 圖片上傳區域 -->
      <div class="space-y-4">
        <input
          type="file"
          accept="image/jpeg,image/png,image/webp"
          (change)="onImageSelected($event)"
          class="hidden"
          #fileInput>

        @if (!imagePreview()) {
          <!-- 上傳區域 -->
          <div
            class="border-2 border-dashed border-grey-d4 rounded-lg p-8 text-center cursor-pointer hover:border-primary hover:bg-grey-f7 transition-colors"
            (click)="fileInput.click()">
            <mat-icon class="text-grey-9f mb-4" style="font-size: 3rem; width: 3rem; height: 3rem;">cloud_upload</mat-icon>
            <p class="text-grey-66 mb-2">點擊選擇圖片或拖拽圖片至此</p>
            <p class="text-sm text-grey-9f">支援 JPG、PNG、WebP 格式，檔案大小不超過 5MB</p>
          </div>
        } @else {
          <!-- 圖片預覽 -->
          <div class="space-y-4">
            <div class="relative inline-block">
              <img
                [src]="imagePreview()"
                alt="課程圖片預覽"
                class="w-64 h-48 object-cover rounded-lg border border-grey-d4 cursor-pointer hover:opacity-80 transition-opacity"
                (click)="fileInput.click()">
              <button
                type="button"
                (click)="removeImage()"
                class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm hover:bg-red-600 transition-colors">
                ×
              </button>
            </div>
            <p class="text-sm text-grey-66">點擊圖片可更換圖片</p>
          </div>
        }
      </div>
    </div>

    <!-- 課程基本資訊 -->
    <div class="bg-white border border-grey-d4 rounded-xl shadow-sm p-6">
      <h2 class="text-xl font-semibold text-grey-33 mb-6">課程基本資訊</h2>

      <div class="space-y-6">
        <!-- 課程名稱 -->
        <div>
          <label class="block text-sm font-medium text-grey-33 mb-2">課程名稱 <span class="text-red-500">*</span></label>
          <tmf-input-text
            formControlName="name"
            placeholder="請輸入課程名稱">
          </tmf-input-text>
        </div>

        <!-- 課程內容 -->
        <div>
          <label class="block text-sm font-medium text-grey-33 mb-2">課程內容 <span class="text-red-500">*</span></label>
          <textarea
            formControlName="content"
            rows="4"
            placeholder="請詳細描述課程內容、教學方式和學習目標"
            class="w-full px-3 py-2 border border-grey-d4 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none">
          </textarea>
        </div>

        <!-- 主類別和次類別 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-grey-33 mb-2">主類別 <span class="text-red-500">*</span></label>
            <tmf-input-select
              formControlName="main_category_id"
              placeholder="請選擇主類別"
              [options]="mainCategories()">
            </tmf-input-select>
          </div>

          <div>
            <label class="block text-sm font-medium text-grey-33 mb-2">次類別 <span class="text-red-500">*</span></label>
            <tmf-input-multi-select
              formControlName="sub_category_ids"
              placeholder="請選擇次類別"
              [options]="getAvailableSubCategories()">
            </tmf-input-multi-select>
          </div>
        </div>

        <!-- 城市 -->
        <div class="w-full md:w-1/2">
          <label class="block text-sm font-medium text-grey-33 mb-2">城市 <span class="text-red-500">*</span></label>
          <tmf-input-select
            formControlName="city"
            placeholder="請選擇城市"
            [options]="cities()">
          </tmf-input-select>
        </div>

        <!-- 問卷網址 -->
        <div>
          <label class="block text-sm font-medium text-grey-33 mb-2">問卷網址</label>
          <tmf-input-text
            formControlName="survey_url"
            placeholder="請輸入問卷網址 (選填)">
          </tmf-input-text>
        </div>

        <!-- 購買訊息 -->
        <div>
          <label class="block text-sm font-medium text-grey-33 mb-2">購買訊息</label>
          <textarea
            formControlName="purchase_message"
            rows="3"
            placeholder="學員購買後會看到的訊息 (選填)"
            class="w-full px-3 py-2 border border-grey-d4 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none">
          </textarea>
        </div>
      </div>
    </div>

    <!-- 課程方案 -->
    <div class="bg-white border border-grey-d4 rounded-xl shadow-sm p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-grey-33">課程方案</h2>
        <tmf-button
          type="button"
          variant="secondary"
          size="sm"
          iconPosition="left"
          iconName="add"
          class="h-10"
          (click)="addCoursePlan()">
          新增方案
        </tmf-button>
      </div>

      <div formArrayName="course_plans" class="space-y-4">
        @for (plan of coursePlans.controls; track $index; let i = $index) {
          <div [formGroupName]="i" class="border border-grey-d4 rounded-lg p-4">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-medium text-grey-33">方案 {{ i + 1 }}</h3>
              @if (canRemovePlan(i)) {
                <button
                  type="button"
                  (click)="removeCoursePlan(i)"
                  class="text-red-500 hover:text-red-700 transition-colors cursor-pointer">
                  <mat-icon class="text-lg">delete</mat-icon>
                </button>
              }
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-grey-33 mb-2">堂數 <span class="text-red-500">*</span></label>
                <div class="relative">
                  @if (isDefaultPlan(i)) {
                    <input
                      type="number"
                      formControlName="quantity"
                      min="1"
                      class="w-full px-3 py-2 border border-grey-d4 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-grey-f7"
                      readonly>
                  } @else {
                    <input
                      type="number"
                      formControlName="quantity"
                      min="1"
                      placeholder="請輸入堂數"
                      class="w-full px-3 py-2 border border-grey-d4 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                  }
                  <span class="absolute right-3 top-2 text-grey-66">堂</span>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-grey-33 mb-2">價格 <span class="text-red-500">*</span></label>
                <div class="relative">
                  <input
                    type="number"
                    formControlName="price"
                    min="0"
                    placeholder="請輸入價格"
                    class="w-full px-3 py-2 pr-8 border border-grey-d4 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                  <span class="absolute right-3 top-2 text-grey-66">元</span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- 操作按鈕 -->
    <div class="flex gap-4 pt-6">
      <tmf-button
        type="button"
        class="flex-1 h-10"
        (click)="saveCourse()"
        [disabled]="!courseForm.valid">
        儲存課程
      </tmf-button>

      <tmf-button
        type="button"
        class="h-10"
        variant="secondary"
        (click)="cancel()">
        取消
      </tmf-button>
    </div>
  </form>
</div>
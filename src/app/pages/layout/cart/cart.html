<section class="bg-white py-10 xl:pt-10 xl:pb-20">
  <div class="container mx-auto w-full max-w-320 flex flex-col gap-6">
    <!-- 步驟指示器 -->
    <tmf-stepper 
      class="py-4"
      [steps]="steps" 
      [currentStep]="currentStep()"
      [showOnlyCurrentLabel]="false"
      (stepChange)="onStepChange($event)"
    ></tmf-stepper>

    <!-- 主要內容區 -->
    <div class="flex flex-col gap-6 xl:flex-row">
      <!-- 第一步：購物車清單 -->
      @if (currentStep() === 1) {
        <div class="w-full xl:w-238.5">
        <tmf-table>
          <!-- 表頭 -->
          <div thead class="flex w-full">
            <div class="flex w-12 items-center justify-center py-2 px-4">
              <input
                type="checkbox"
                [checked]="isAllSelected()"
                [indeterminate]="isSomeSelected()"
                (change)="toggleSelectAll()"
                class="h-5 w-5 rounded border border-grey-d4 bg-white"
              />
            </div>
            <div class="flex-1 px-4 flex items-center">
              <span class="text-sm text-white">課程</span>
            </div>
            <div class="w-35 px-3 text-center flex items-center justify-center">
              <span class="text-sm text-white">售價</span>
            </div>
            <div class="w-30 px-3 text-center flex items-center justify-center">
              <span class="text-sm text-white">操作</span>
            </div>
          </div>

          <!-- 載入狀態 -->
          @if (cartResource.isLoading()) {
            @for (item of [1,2,3]; track item) {
              <div tbody class="h-36 flex border-b border-grey-d4 bg-white">
                <div class="flex w-12 items-center justify-center px-4">
                  <tmf-skeleton class="h-5 w-5 rounded"></tmf-skeleton>
                </div>
                <div class="flex flex-1 items-center gap-3 px-4">
                  <tmf-skeleton class="h-28 w-50 rounded-lg"></tmf-skeleton>
                  <div class="flex flex-col gap-2">
                    <tmf-skeleton class="h-4 w-32"></tmf-skeleton>
                    <tmf-skeleton class="h-6 w-48"></tmf-skeleton>
                    <tmf-skeleton class="h-4 w-24"></tmf-skeleton>
                  </div>
                </div>
                <div class="flex w-35 items-center justify-center px-3">
                  <tmf-skeleton class="h-6 w-20"></tmf-skeleton>
                </div>
                <div class="flex w-30 items-center justify-center gap-3 px-3">
                  <tmf-skeleton class="h-6 w-6 rounded"></tmf-skeleton>
                </div>
              </div>
            }
          }

          <!-- 錯誤狀態 -->
          @else if (!!cartResource.error()) {
            <div tbody class="h-36 flex border-b border-grey-d4 bg-white">
              <div class="flex items-center justify-center w-full h-full">
                <span class="text-red-500">載入購物車失敗，請重新整理頁面</span>
              </div>
            </div>
          }

          <!-- 空購物車狀態 -->
          @else if (cartItems().length === 0) {
            <div tbody class="h-36 flex border-b border-grey-d4 bg-white">
              <div class="flex items-center justify-center w-full h-full">
                <div class="text-center">
                  <p class="text-grey-66 mb-4">購物車是空的</p>
                  <tmf-button (click)="cartService.goToSearch()" variant="secondary">探索課程</tmf-button>
                </div>
              </div>
            </div>
          }

          <!-- 購物車項目 -->
          @else if (cartResource.value() && cartItems().length > 0) {
            <ng-container tbody>
              @for (courseItem of itemsWithSelection(); track courseItem.id || $index; let i = $index) {
                <div class="h-36 flex border-b border-grey-d4 bg-white transition-colors hover:bg-grey-f7">
                  <!-- 勾選欄位 -->
                  <div class="flex w-12 items-center justify-center px-4">
                    <input
                      type="checkbox"
                      [checked]="courseItem.isSelected"
                      (change)="toggleSelectItem(courseItem)"
                      class="h-5 w-5 rounded border transition-colors duration-200"
                    />
                  </div>

                  <!-- 課程內容 -->
                  <div class="flex flex-1 items-center gap-3 px-4">
                    <!-- 課程圖片 -->
                    @if (courseItem.course?.main_image) {
                      <img
                        [src]="courseItem.course?.main_image"
                        [alt]="courseItem.course?.name || '課程'"
                        class="w-50 h-28 object-cover rounded-lg"
                      />
                    } @else {
                      <div class="w-20 h-20 bg-grey-e9 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-grey-9f text-2xl">school</span>
                      </div>
                    }

                    <!-- 課程資訊 -->
                    <div class="flex flex-col gap-1">
                      <!-- 課程類別 -->
                      @if (courseItem.course?.main_category || courseItem.course?.sub_category) {
                        <div class="flex gap-2">
                          @if (courseItem.course?.main_category) {
                            <span class="rounded bg-grey-d4 px-2 py-1 text-sm text-grey-33">{{ courseItem.course?.main_category?.name }}</span>
                          }
                          @if (courseItem.course?.sub_category) {
                            <span class="rounded bg-grey-d4 px-2 py-1 text-sm text-grey-33">{{ courseItem.course?.sub_category?.name }}</span>
                          }
                        </div>
                      }
                      <!-- 課程標題 -->
                      <h3 class="text-base text-grey-33 line-clamp-2">{{ courseItem.course?.name || '課程名稱' }}</h3>
                      <!-- 價格方案 -->
                      <p class="text-sm text-grey-66">{{ (courseItem.price_option?.quantity || 1) * (courseItem.quantity || 1) }} 堂課程</p>
                    </div>
                  </div>

                  <!-- 價格與數量控制 -->
                  <div class="flex w-35 flex-col items-center justify-center gap-2 px-3">
                    <!-- 價格 -->
                    <span class="font-inter text-lg font-medium text-grey-33">
                      NT$ {{ ((courseItem.price_option?.price || 0) * (courseItem.quantity || 1)) | number:'1.0-0' }}
                    </span>
                    <!-- 數量控制 -->
                    <div class="flex items-center gap-2">
                      <button
                        class="cursor-pointer flex h-8 w-8 items-center justify-center rounded border border-grey-d4 text-grey-66 hover:bg-grey-f7 disabled:opacity-50"
                        [disabled]="courseItem.quantity! <= 1 || isUpdating().has(courseItem.id!)"
                        (click)="updateQuantity(courseItem.id!, (courseItem.quantity || 1) - 1)"
                      >
                        <mat-icon class="!leading-4 !text-base !h-4 !w-4">remove</mat-icon>
                      </button>
                      <span class="w-8 text-center text-sm">{{ courseItem.quantity || 1 }}</span>
                      <button
                        class="cursor-pointer flex h-8 w-8 items-center justify-center rounded border border-grey-d4 text-grey-66 hover:bg-grey-f7 disabled:opacity-50"
                        [disabled]="isUpdating().has(courseItem.id!)"
                        (click)="updateQuantity(courseItem.id!, (courseItem.quantity || 1) + 1)"
                      >
                        <mat-icon class="!leading-4 !text-base !h-4 !w-4">add</mat-icon>
                      </button>
                    </div>
                  </div>

                  <!-- 操作 -->
                  <div class="flex w-30 items-center justify-center px-3">
                    <button
                      class="cursor-pointer text-grey-66 hover:text-grey-33 disabled:opacity-50"
                      [disabled]="isRemoving().has(courseItem.id!)"
                      (click)="removeItem(courseItem.id!)"
                    >
                      @if (isRemoving().has(courseItem.id!)) {
                        <mat-icon class="!text-6 !h-6 !w-6 animate-spin">hourglass_empty</mat-icon>
                      } @else {
                        <mat-icon class="!text-6 !h-6 !w-6">delete</mat-icon>
                      }
                    </button>
                  </div>
                </div>
              }
            </ng-container>
          }
        </tmf-table>
        </div>
      }

      <!-- 第二步：訂單資訊表單 -->
      @if (currentStep() === 2) {
        <div class="w-full xl:w-238.5">
          <!-- 訂單內容摘要 -->
          <div class="bg-white rounded-xl p-6 shadow-lg mb-6">
            <h2 class="text-xl-bold leading-7 text-grey-33 mb-4">訂單內容</h2>
            <div class="space-y-4">
              @for (item of selectedCartItems(); track item.id) {
                <div class="flex items-center gap-4 p-4 border border-grey-e9 rounded-lg">
                  <!-- 課程圖片 -->
                  @if (item.course?.main_image) {
                    <img
                      [src]="item.course?.main_image"
                      [alt]="item.course?.name || '課程'"
                      class="w-16 h-16 object-cover rounded-lg flex-shrink-0"
                    />
                  } @else {
                    <div class="w-16 h-16 bg-grey-e9 rounded-lg flex items-center justify-center flex-shrink-0">
                      <span class="material-symbols-outlined text-grey-9f text-xl">school</span>
                    </div>
                  }

                  <!-- 課程資訊 -->
                  <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-medium text-grey-33 line-clamp-2">{{ item.course?.name || '課程名稱' }}</h3>
                    <p class="text-sm text-grey-66 mt-1">
                      {{ (item.price_option?.quantity || 1) * (item.quantity || 1) }} 堂課程 × {{ item.quantity || 1 }}
                    </p>
                  </div>

                  <!-- 價格 -->
                  <div class="text-right flex-shrink-0">
                    <span class="text-lg font-medium text-grey-33">
                      NT$ {{ ((item.price_option?.price || 0) * (item.quantity || 1)) | number:'1.0-0' }}
                    </span>
                  </div>
                </div>
              }

              <!-- 總計 -->
              <div class="border-t pt-4">
                <div class="flex justify-between items-center">
                  <span class="text-lg font-medium text-grey-33">總計</span>
                  <span class="text-xl font-bold text-grey-33">
                    NT$ {{ selectedTotalPrice() | number:'1.0-0' }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- 訂單資訊表單 -->
          <form [formGroup]="orderForm" class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-xl-bold leading-7 text-grey-33 mb-6">訂單資訊</h2>

            <!-- 購買者姓名 -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-grey-33 mb-2">
                購買者姓名 <span class="text-red-500">*</span>
              </label>
              <tmf-input-text
                formControlName="buyer_name"
                placeholder="請輸入購買者姓名"
              ></tmf-input-text>
              @if (getFieldError('buyer_name')) {
                <p class="text-red-500 text-sm mt-1">{{ getFieldError('buyer_name') }}</p>
              }
            </div>

            <!-- 手機號碼 -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-grey-33 mb-2">
                手機號碼 <span class="text-red-500">*</span>
              </label>
              <tmf-input-text
                formControlName="buyer_phone"
                placeholder="請輸入手機號碼 (09開頭的10位數字)"
              ></tmf-input-text>
              @if (getFieldError('buyer_phone')) {
                <p class="text-red-500 text-sm mt-1">{{ getFieldError('buyer_phone') }}</p>
              }
            </div>

            <!-- 電子信箱 -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-grey-33 mb-2">
                電子信箱 <span class="text-red-500">*</span>
              </label>
              <tmf-input-text
                formControlName="buyer_email"
                type="email"
                placeholder="請輸入電子信箱"
              ></tmf-input-text>
              @if (getFieldError('buyer_email')) {
                <p class="text-red-500 text-sm mt-1">{{ getFieldError('buyer_email') }}</p>
              }
            </div>

            <!-- 付款方式 -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-grey-33 mb-2">
                付款方式 <span class="text-red-500">*</span>
              </label>
              <tmf-input-select
                formControlName="purchase_way"
                [options]="paymentOptions"
                placeholder="請選擇付款方式"
              ></tmf-input-select>
            </div>

          </form>
        </div>
      }

      <!-- 第三步：付款處理中 -->
      @if (currentStep() === 3) {
        <div class="w-full xl:w-238.5">
          <div class="bg-white rounded-xl p-6 shadow-lg text-center">
            <div class="py-8">
              <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
              <h2 class="text-xl-bold leading-7 text-grey-33 mb-2">處理付款中...</h2>
              <p class="text-grey-66">正在建立訂單並跳轉至付款頁面，請稍候</p>
            </div>
          </div>
        </div>
      }

      <!-- 右側訂單總計 -->
      <div class="w-full xl:w-75.5 xl:flex-1">
        <div class="flex flex-col gap-6 rounded-xl bg-white p-6 shadow-lg">
          <!-- 標題 -->
          <h2 class="text-xl-bold leading-7 text-grey-33">我的訂單</h2>

          <!-- 統計資訊 -->
          <div class="space-y-3 pt-6">
            <!-- 共計 -->
            <div class="flex justify-end items-center gap-1 text-lg text-grey-66">
              <span>共計</span>
              <span class="font-inter font-medium">{{ selectedItems().size }}</span>
              <span>項課程</span>
            </div>

            <!-- 總計 -->
            <div class="flex justify-end items-baseline gap-1">
              <span class="text-base text-grey-33">總計</span>
              <span class="font-inter text-4xl font-medium uppercase text-grey-33">NT$</span>
              <span class="font-inter text-4xl font-medium uppercase text-grey-33">{{ selectedTotalPrice() | number:'1.0-0' }}</span>
            </div>
          </div>

          <!-- 第一步按鈕區 -->
          @if (currentStep() === 1) {
            <div class="space-y-4">
              <tmf-button
                class="h-13"
                [disabled]="selectedItems().size === 0"
                (click)="checkout()"
              >
                前往結帳
              </tmf-button>
              <tmf-button
                class="h-13"
                variant="secondary"
                (click)="cartService.goToSearch()"
              >
                繼續購物
              </tmf-button>
              <tmf-button
                class="h-13"
                variant="secondary"
                (click)="clearCart()"
                [disabled]="cartItems().length === 0"
              >
                清空購物車
              </tmf-button>
            </div>
          }

          <!-- 第二步：訂單確認按鈕 -->
          @if (currentStep() === 2) {
            <div class="space-y-4">
              <tmf-button
                class="h-13"
                [disabled]="isCheckingOut()"
                (click)="submitOrder()"
              >
                @if (isCheckingOut()) {
                  處理中...
                } @else {
                  確認訂單並付款
                }
              </tmf-button>
              <tmf-button
                class="h-13"
                variant="secondary"
                (click)="currentStep.set(1)"
              >
                返回購物車
              </tmf-button>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</section>
<!-- 我的收藏區塊（只在第一步顯示） -->
@if (currentStep() === 1) {
  <section class="bg-grey-f7 py-10 xl:pt-10 xl:pb-20">
    <div class="container mx-auto w-full max-w-320">
      <!-- 段落標題 -->
      <tmf-course-detail-section-title class="mb-6">
        我的收藏
      </tmf-course-detail-section-title>

      <!-- 收藏課程卡片列表 -->
      <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        @for (course of favoriteCoursesData(); track course.id) {
          <tmf-course-card [course]="course"></tmf-course-card>
        }
      </div>
    </div>
  </section>
}
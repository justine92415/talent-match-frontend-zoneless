<form
  [formGroup]="workExperienceForm"
  (ngSubmit)="onSubmit()"
  class="space-y-6"
>
  <div formArrayName="experiences">
    @for (experience of experiencesArray.controls; track $index) {
      <div
        [formGroupName]="$index"
        class="border border-grey-d4 rounded-xl p-6 space-y-4 relative"
      >
        <!-- 刪除按鈕 -->
        @if (experiencesArray.length > 1) {
          <button
            type="button"
            (click)="removeExperience($index)"
            class="absolute top-4 right-4 text-red-500 hover:text-red-700 transition-colors"
          >
            <mat-icon [fontIcon]="TmfIcon.Delete"></mat-icon>
          </button>
        }

        <h3 class="text-lg font-medium text-grey-33">工作經驗 {{ $index + 1 }}</h3>

        <!-- 公司名稱 -->
        <div class="space-y-2">
          <label class="block text-base font-medium text-grey-33">公司名稱</label>
          <tmf-input-text
            placeholder="請輸入公司名稱"
            formControlName="company_name"
          ></tmf-input-text>
          @if (
            experience.get("company_name")?.invalid &&
            experience.get("company_name")?.touched
          ) {
            <div class="text-red-500 text-sm">請輸入公司名稱</div>
          }
        </div>

        <!-- 工作地點 -->
        <div class="space-y-4">
          <label class="block text-base font-medium text-grey-33">工作地點</label>
          
          <div class="flex flex-col md:flex-row gap-4">
            <!-- 縣市 -->
            <div class="space-y-2">
              <label class="block text-sm text-grey-66">縣市</label>
              <tmf-input-select
                [placeholder]="'請選擇縣市'"
                [options]="cityOptions"
                formControlName="workplace_city"
              ></tmf-input-select>
              @if (
                experience.get("workplace_city")?.invalid &&
                experience.get("workplace_city")?.touched
              ) {
                <div class="text-red-500 text-sm">請選擇縣市</div>
              }
            </div>

            <!-- 地區 -->
            <div class="space-y-2">
              <label class="block text-sm text-grey-66">地區</label>
              <tmf-input-select
                [placeholder]="'請選擇地區'"
                [options]="getDistrictOptions(experience.get('workplace_city')?.value)"
                formControlName="workplace_district"
              ></tmf-input-select>
              @if (
                experience.get("workplace_district")?.invalid &&
                experience.get("workplace_district")?.touched
              ) {
                <div class="text-red-500 text-sm">請選擇地區</div>
              }
            </div>
          </div>

          <!-- 詳細地址 -->
          <div class="space-y-2">
            <label class="block text-sm text-grey-66">詳細地址</label>
            <tmf-input-text
              placeholder="請輸入詳細地址"
              formControlName="workplace_address"
            ></tmf-input-text>
            @if (
              experience.get("workplace_address")?.invalid &&
              experience.get("workplace_address")?.touched
            ) {
              <div class="text-red-500 text-sm">請輸入詳細地址</div>
            }
          </div>
        </div>

        <!-- 工作類別與職稱 -->
        <div class="flex flex-col md:flex-row gap-4">
          <div class="space-y-2">
            <label class="block text-base font-medium text-grey-33">工作類別</label>
            <tmf-input-select
              [placeholder]="'請選擇工作類別'"
              [options]="jobCategoryOptions"
              formControlName="job_category"
            ></tmf-input-select>
            @if (
              experience.get("job_category")?.invalid &&
              experience.get("job_category")?.touched
            ) {
              <div class="text-red-500 text-sm">請選擇工作類別</div>
            }
          </div>

          <div class="space-y-2">
            <label class="block text-base font-medium text-grey-33">職稱</label>
            <tmf-input-text
              placeholder="請輸入職稱"
              formControlName="job_title"
            ></tmf-input-text>
            @if (
              experience.get("job_title")?.invalid &&
              experience.get("job_title")?.touched
            ) {
              <div class="text-red-500 text-sm">請輸入職稱</div>
            }
          </div>
        </div>

        <!-- 目前在職 checkbox -->
        <div class="flex items-center space-x-2">
          <input
            type="checkbox"
            formControlName="is_working"
            class="w-4 h-4 text-primary border-grey-d4 rounded focus:ring-primary"
          />
          <label class="text-base text-grey-33">目前在職</label>
        </div>

        <!-- 工作期間 -->
        <div class="space-y-4">
          <label class="block text-base font-medium text-grey-33">工作期間</label>
          
          <!-- 開始時間 -->
          <div class="space-y-2">
            <label class="block text-sm text-grey-66">開始時間</label>
            <div class="flex gap-4">
              <tmf-input-select
                [placeholder]="'年'"
                [options]="yearOptions"
                formControlName="start_year"
                class="flex-1"
              ></tmf-input-select>
              <tmf-input-select
                [placeholder]="'月'"
                [options]="monthOptions"
                formControlName="start_month"
                class="flex-1"
              ></tmf-input-select>
            </div>
            @if (
              (experience.get("start_year")?.invalid && experience.get("start_year")?.touched) ||
              (experience.get("start_month")?.invalid && experience.get("start_month")?.touched)
            ) {
              <div class="text-red-500 text-sm">請選擇開始時間</div>
            }
          </div>

          <!-- 結束時間 -->
          @if (!experience.get("is_working")?.value) {
            <div class="space-y-2">
              <label class="block text-sm text-grey-66">結束時間</label>
              <div class="flex gap-4">
                <tmf-input-select
                  [placeholder]="'年'"
                  [options]="yearOptions"
                  formControlName="end_year"
                  class="flex-1"
                ></tmf-input-select>
                <tmf-input-select
                  [placeholder]="'月'"
                  [options]="monthOptions"
                  formControlName="end_month"
                  class="flex-1"
                ></tmf-input-select>
              </div>
              @if (
                (experience.get("end_year")?.invalid && experience.get("end_year")?.touched) ||
                (experience.get("end_month")?.invalid && experience.get("end_month")?.touched)
              ) {
                <div class="text-red-500 text-sm">請選擇結束時間</div>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- 新增工作經驗按鈕 -->
  <div class="flex justify-center">
    <tmf-button
      type="button"
      variant="secondary"
      (click)="addExperience()"
      class="flex items-center gap-2"
    >
      <mat-icon [fontIcon]="TmfIcon.Add"></mat-icon>
      新增工作經驗
    </tmf-button>
  </div>
</form>
